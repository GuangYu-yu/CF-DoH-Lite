export default{async fetch(e){const n=new URL(e.url),r=n.pathname;if("OPTIONS"===e.method)return new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"*","Access-Control-Max-Age":"86400"}});const t=n.searchParams.get("token");if(!t||"getdns"!==t)return new Response("Authentication failed",{status:403});switch(r){case"/dns-query":return await handleDnsQuery(e);case"/resolve":return await handleDomainResolve(e);default:return new Response('\nDNS查询服务\n\n可用端点：\n• /dns-query - 标准DNS over HTTPS查询\n• /resolve - 简化域名解析（JSON格式）\n\n示例：\ncurl "https://your-worker.workers.dev/resolve?name=google.com&type=A"\n        ',{headers:{"Content-Type":"text/plain; charset=utf-8","Access-Control-Allow-Origin":"*"}})}}};async function handleDnsQuery(e){if(!["POST","GET"].includes(e.method))return new Response("Method Not Allowed",{status:405});try{const n=await extractDnsQuery(e);if(!n||n.length<12)return new Response("Invalid DNS query",{status:400});const r=await forwardDnsQuery(n);return r?new Response(r,{headers:{"Content-Type":"application/dns-message","Access-Control-Allow-Origin":"*","Cache-Control":"no-cache, no-store, must-revalidate"}}):new Response("DNS query failed",{status:502})}catch(e){return new Response("Internal Server Error",{status:500})}}async function handleDomainResolve(e){if("GET"!==e.method)return jsonResponse({error:"Method Not Allowed"},405);const n=new URL(e.url),r=n.searchParams.get("name");if(!r)return jsonResponse({error:"Missing name parameter"},400);const t=n.searchParams.get("type")||"all";try{if("all"===t){const[e,n]=await Promise.all([queryDnsRecord(r,"A"),queryDnsRecord(r,"AAAA")]);return jsonResponse({domain:r,type:"all",status:"success",a_records:e||{status:"failed"},aaaa_records:n||{status:"failed"}})}const e=await queryDnsRecord(r,t);return e?jsonResponse(e):jsonResponse({error:"DNS query failed",domain:r,type:t},502)}catch(e){return jsonResponse({error:"Internal Server Error",message:e.message},500)}}async function extractDnsQuery(e){if("POST"===e.method){const n=e.headers.get("content-type")||"";if(n.includes("application/dns-message"))return new Uint8Array(await e.arrayBuffer());if(n.includes("application/x-www-form-urlencoded")){const n=await e.text(),r=new URLSearchParams(n).get("dns");return r?base64urlToUint8Array(r):null}return null}const n=new URL(e.url).searchParams.get("dns");return n?base64urlToUint8Array(n):null}async function queryDnsRecord(e,n){const r=buildDnsQuery(e,n),t=await forwardDnsQuery(r);return t?parseDnsResponse(t,e,n):null}function jsonResponse(e,n=200){return new Response(JSON.stringify(e,null,2),{status:n,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}async function forwardDnsQuery(e){const n=["https://cloudflare-dns.com/dns-query","https://dns.google/dns-query"],r=uint8ArrayToBase64url(e);for(const e of n)try{const n=new AbortController,t=setTimeout(()=>n.abort(),5e3),s=await fetch(`${e}?dns=${r}`,{method:"GET",headers:{Accept:"application/dns-message"},signal:n.signal});if(clearTimeout(t),s.ok)return new Uint8Array(await s.arrayBuffer())}catch(e){continue}return null}function base64urlToUint8Array(e){let n=e.replace(/-/g,"+").replace(/_/g,"/");for(;n.length%4!=0;)n+="=";try{const e=atob(n);return new Uint8Array([...e].map(e=>e.charCodeAt(0)))}catch{return null}}function uint8ArrayToBase64url(e){return btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function buildDnsQuery(e,n){const r={A:1,AAAA:28,CNAME:5,NS:2};let t;t=isNaN(n)?r[n]||1:parseInt(n);const s=new Uint8Array(12),a=new DataView(s.buffer);a.setUint16(0,Math.floor(65536*Math.random()),!1),a.setUint16(2,256,!1),a.setUint16(4,1,!1);const o=e.split(".").flatMap(e=>[e.length,...e.split("").map(e=>e.charCodeAt(0))]);o.push(0);const l=new Uint8Array([...o,t>>8&255,255&t,0,1]);return new Uint8Array([...s,...l])}function parseDnsResponse(e,n,r){if(e.length<12)return{domain:n,type:r,status:"error",error:"Invalid DNS response"};const t=new DataView(e.buffer),s=15&t.getUint16(2,!1);if(0!==s)return{domain:n,type:r,status:"error",error:`DNS error code: ${s}`};const a=t.getUint16(6,!1);if(0===a)return{domain:n,type:r,status:"no_records",answers:[]};const o=[];let l=skipDnsName(e,12)+4;for(let n=0;n<a&&l<e.length;n++){const n=parseDnsAnswer(e,l);if(!n)break;o.push(n),l=n.nextOffset}return{domain:n,type:r,status:"success",count:a,answers:o}}function compressIPv6(e){let n=e.split(":").map(e=>e.replace(/^0+/,"")||"0"),r=[0,0],t=[0,0];for(let e=0;e<8;e++)"0"===n[e]?t[1]++:t=[[e,0]];for(let e=0;e<8;e++){let t=e,s=0;for(;"0"===n[e];)e++,s++;s>r[1]&&(r=[t,s])}return r[1]>1&&(n.splice(r[0],r[1],""),0===r[0]&&n.unshift(""),r[0]+r[1]===8&&n.push("")),n.join(":").replace(/:{3,}/,"::")}function parseDnsAnswer(e,n){if(n>=e.length)return null;const r=parseDnsName(e,n);if(!r)return null;if((n=r.nextOffset)+10>e.length)return null;const t=new DataView(e.buffer),s=t.getUint16(n,!1),a=t.getUint32(n+4,!1),o=t.getUint16(n+8,!1);if((n+=10)+o>e.length)return null;const l=parseRecordData(e,n,s,o);return{name:r.name,type:{1:"A",28:"AAAA",5:"CNAME",2:"NS"}[s]||s,ttl:a,data:l,nextOffset:n+o}}function parseRecordData(e,n,r,t){const s=new DataView(e.buffer);switch(r){case 1:if(4===t)return`${e[n]}.${e[n+1]}.${e[n+2]}.${e[n+3]}`;break;case 28:if(16===t){const e=[];for(let r=0;r<16;r+=2)e.push(s.getUint16(n+r,!1).toString(16).padStart(4,"0"));return compressIPv6(e.join(":"))}break;case 5:case 2:const r=parseDnsName(e,n);return r?r.name:""}return""}function parseDnsName(e,n){const r=[];let t=n;for(;t<e.length;){const n=e[t];if(0===n){t++;break}if(!(192&~n)){if(t+1>=e.length)return null;const s=parseDnsName(e,(63&n)<<8|e[t+1]);s&&r.push(...s.name.split(".")),t+=2;break}{if(t+n>=e.length)return null;let s="";for(let r=1;r<=n;r++)s+=String.fromCharCode(e[t+r]);r.push(s),t+=n+1}}return{name:r.join("."),nextOffset:t}}function skipDnsName(e,n){let r=n;for(;r<e.length;){const n=e[r];if(0===n){r++;break}if(!(192&~n)){r+=2;break}r+=n+1}return r}
