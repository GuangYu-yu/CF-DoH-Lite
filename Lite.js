const UPSTREAM_DOH_SERVERS=["https://cloudflare-dns.com/dns-query","https://dns.google/dns-query"],GLOBAL_AUTH_TOKEN="";export default{async fetch(e){const n=new URL(e.url),t=n.pathname;if("OPTIONS"===e.method)return new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"*","Access-Control-Max-Age":"86400"}});switch(t){case"/dns-query":return await handleDnsQuery(e);case"/resolve":return await handleDomainResolve(e);default:return new Response("DNS Worker is running.",{headers:{"Content-Type":"text/plain; charset=utf-8"}})}}};async function handleDnsQuery(e){let n;if("GET"===e.method){const t=new URL(e.url).searchParams.get("dns");if(!t)return new Response("Missing dns parameter",{status:400});const r=atob(t.replace(/-/g,"+").replace(/_/g,"/"));n=new Uint8Array(r.length);for(let e=0;e<r.length;e++)n[e]=r.charCodeAt(e)}else{if("POST"!==e.method)return new Response("Method Not Allowed",{status:405});if("application/dns-message"!==e.headers.get("content-type"))return new Response("Unsupported Content-Type",{status:415});n=new Uint8Array(await e.arrayBuffer())}const t=await forwardDnsQuery(n);return t?new Response(t,{headers:{"Content-Type":"application/dns-message"}}):new Response("DNS query failed",{status:502})}async function handleDomainResolve(e){if("GET"!==e.method)return jsonResponse({error:"Method Not Allowed"},405);const n=new URL(e.url),t=n.searchParams.get("name");if(!t)return jsonResponse({error:"Missing name parameter"},400);const r=n.searchParams.get("type"),s=n.searchParams.get("server"),o=s?[s]:UPSTREAM_DOH_SERVERS;try{if(r){const e=await queryDnsRecord(t,r,o);return e?jsonResponse(e):jsonResponse({error:"DNS query failed",domain:t,type:r},502)}{const[e,n]=await Promise.all([queryDnsRecord(t,"A",o),queryDnsRecord(t,"AAAA",o)]);return jsonResponse({domain:t,types:["A","AAAA"],status:"success",results:{A:e,AAAA:n}})}}catch(e){return jsonResponse({error:"Internal Server Error",message:e.message},500)}}async function forwardDnsQuery(e,n=UPSTREAM_DOH_SERVERS){for(const t of n)try{const n=new AbortController,r=setTimeout(()=>n.abort(),500),s=await fetch(t,{method:"POST",headers:{Accept:"application/dns-message","Content-Type":"application/dns-message"},body:e,signal:n.signal});if(clearTimeout(r),s.ok)return new Uint8Array(await s.arrayBuffer());console.warn(`Upstream ${t} returned status ${s.status}`)}catch(e){console.error(`DNS query failed for ${t}:`,e.message);continue}return null}async function queryDnsRecord(e,n,t=UPSTREAM_DOH_SERVERS){const r=buildDnsQuery(e,n);if(!r)return null;const s=await forwardDnsQuery(r,t);return s?parseDnsResponse(s,e,n):null}function jsonResponse(e,n=200){return new Response(JSON.stringify(e,null,2),{status:n,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}function buildDnsQuery(e,n){let t="string"==typeof n?{A:1,AAAA:28,CNAME:5,NS:2,TXT:16,MX:15}[n.toUpperCase()]:n;if(t||isNaN(n)||(t=parseInt(n)),!t)return null;const r=new Uint8Array(12),s=new DataView(r.buffer);s.setUint16(0,Math.floor(65535*Math.random()),!1),s.setUint16(2,256,!1),s.setUint16(4,1,!1);const o=e.split(".");let a=0;for(const e of o)a+=e.length+1;a+=1;const l=new Uint8Array(a+4);let u=0;for(const e of o){if(e.length>63)return null;l[u]=e.length,u++;for(let n=0;n<e.length;n++)l[u]=e.charCodeAt(n),u++}l[u]=0,u++;const i=new DataView(l.buffer);i.setUint16(u,t,!1),i.setUint16(u+2,1,!1);const c=new Uint8Array(12+l.length);return c.set(r),c.set(l,12),c}function parseDnsResponse(e,n,t){if(e.length<12)return{domain:n,type:t,status:"error",error:"Invalid DNS response"};const r=new DataView(e.buffer),s=15&r.getUint16(2,!1);if(0!==s)return{domain:n,type:t,status:"error",error:`DNS error code: ${s}`};const o=r.getUint16(6,!1);if(0===o)return{domain:n,type:t,status:"no_records",answers:[]};const a=[];let l=skipDnsName(e,12)+4;for(let n=0;n<o&&l<e.length;n++){const n=parseDnsAnswer(e,l);if(!n)break;a.push(n),l=n.nextOffset}return{domain:n,type:t,status:"success",count:o,answers:a}}function skipDnsName(e,n){let t=n;for(;t<e.length;){const n=e[t];if(0===n){t++;break}if(!(192&~n)){t+=2;break}t+=n+1}return t}function parseDnsAnswer(e,n){if(n>=e.length)return null;const t=parseDnsName(e,n);if(!t)return null;if((n=t.nextOffset)+10>e.length)return null;const r=new DataView(e.buffer),s=r.getUint16(n,!1),o=r.getUint32(n+4,!1),a=r.getUint16(n+8,!1);if((n+=10)+a>e.length)return null;const l=parseRecordData(e,n,s,a);return{name:t.name,type:{1:"A",28:"AAAA",5:"CNAME",2:"NS",16:"TXT",15:"MX"}[s]||s,ttl:o,data:l,nextOffset:n+a}}function parseDnsName(e,n){const t=[];let r=n;for(;r<e.length;){const n=e[r];if(0===n){r++;break}if(!(192&~n)){if(r+1>=e.length)return null;const s=(63&n)<<8|e[r+1];if(s>=r)return null;const o=parseDnsName(e,s);o&&t.push(...o.name.split(".")),r+=2;break}{if(r+1+n>e.length)return null;let s="";for(let t=1;t<=n;t++)s+=String.fromCharCode(e[r+t]);t.push(s),r+=n+1}}return{name:t.join("."),nextOffset:r}}function parseRecordData(e,n,t,r){switch(t){case 1:return 4!==r?null:`${e[n]}.${e[n+1]}.${e[n+2]}.${e[n+3]}`;case 28:if(16!==r)return null;const t=[];for(let r=0;r<16;r+=2){const r=(e[n]<<8|e[n+1]).toString(16);t.push(r),n+=2}return compressIPv6(t.join(":"));case 5:case 2:const s=parseDnsName(e,n);return s?s.name:null;case 16:let o=n,a="";for(;o<n+r;){const t=e[o];if(0===t||o+1+t>n+r)break;a+=(a?" ":"")+String.fromCharCode(...e.slice(o+1,o+1+t)),o+=1+t}return a;case 15:if(r<2)return null;const l=e[n]<<8|e[n+1],u=parseDnsName(e,n+2);return u?`${l} ${u.name}`:null;default:return null}}function compressIPv6(e){const n=e.split(":");let t=-1,r=0,s=-1,o=0;for(let e=0;e<n.length;e++)"0"===n[e]?-1===s?(s=e,o=1):o++:(o>r&&(t=s,r=o),s=-1,o=0);if(o>r&&(t=s,r=o),r>1){return[...n.slice(0,t),"",...n.slice(t+r)].join(":")}return e}
