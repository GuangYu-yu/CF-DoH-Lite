const UPSTREAM_DOH_SERVERS=["https://cloudflare-dns.com/dns-query","https://dns.google/dns-query"],GLOBAL_AUTH_TOKEN="",CACHE_TTL_SECONDS=300,MIN_CACHE_TTL_SECONDS=60,TIMEOUT_MS=500,decoder=new TextDecoder;export default{async fetch(e){const n=new URL(e.url),t=n.pathname;if("OPTIONS"===e.method)return new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"*","Access-Control-Max-Age":"86400"}});switch(t){case"/dns-query":return await handleDnsQuery(e);case"/resolve":return await handleDomainResolve(e);default:return new Response(null,{status:200})}}};async function handleDnsQuery(e){let n;if("GET"===e.method){const t=new URL(e.url).searchParams.get("dns");if(!t)return new Response(null,{status:400});const s=atob(t.replace(/-/g,"+").replace(/_/g,"/"));n=new Uint8Array(s.length);for(let e=0;e<s.length;e++)n[e]=s.charCodeAt(e)}else{if("POST"!==e.method)return new Response(null,{status:405});if("application/dns-message"!==e.headers.get("content-type"))return new Response(null,{status:415});n=new Uint8Array(await e.arrayBuffer())}const{response:t,upstreamCacheControl:s}=await forwardDnsQueryWithCacheControl(n);if(!t)return new Response(null,{status:502});let r=300;if(s){const e=s.match(/max-age=(\d+)/);if(e){const n=parseInt(e[1],10);r=Math.max(60,Math.min(n,300))}}return new Response(t,{headers:{"Content-Type":"application/dns-message","Cache-Control":`public, max-age=${r}`,"Access-Control-Allow-Origin":"*"}})}async function handleDomainResolve(e){if("GET"!==e.method)return jsonResponse({},405);const n=new URL(e.url),t=n.searchParams.get("name");if(!t)return jsonResponse({},400);const s=n.searchParams.get("type"),r=n.searchParams.get("server"),a=r?[r]:UPSTREAM_DOH_SERVERS;if(s){const e=await queryDnsRecord(t,s,a);return e?jsonResponse(e):jsonResponse({},502)}{const[e,n]=await Promise.all([queryDnsRecord(t,"A",a),queryDnsRecord(t,"AAAA",a)]);return jsonResponse({domain:t,types:["A","AAAA"],status:"success",results:{A:e,AAAA:n}})}}async function forwardDnsQueryWithCacheControl(e,n=UPSTREAM_DOH_SERVERS){const t=n.map(async n=>{const t=new AbortController,s=setTimeout(()=>t.abort(),500);try{const r=await fetch(n,{method:"POST",headers:{Accept:"application/dns-message","Content-Type":"application/dns-message"},body:e,signal:t.signal});if(clearTimeout(s),r.ok){const e=r.headers.get("Cache-Control");return{response:new Uint8Array(await r.arrayBuffer()),upstreamCacheControl:e}}throw 0}catch(e){throw clearTimeout(s),e}});try{return await Promise.any(t)}catch(e){return null}}async function forwardDnsQuery(e,n=UPSTREAM_DOH_SERVERS){const t=await forwardDnsQueryWithCacheControl(e,n);return t?t.response:null}async function queryDnsRecord(e,n,t=UPSTREAM_DOH_SERVERS){const s=buildDnsQuery(e,n);if(!s)return null;const r=await forwardDnsQuery(s,t);return r?parseDnsResponse(r,e,n):null}function jsonResponse(e,n=200){return new Response(JSON.stringify(e,null,2),{status:n,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}function buildDnsQuery(e,n){const t={A:1,AAAA:28,CNAME:5,NS:2,TXT:16,MX:15}[n.toUpperCase()]||parseInt(n);if(!t)return null;const s=new TextEncoder,r=e.split(".").map(e=>s.encode(e)),a=r.reduce((e,n)=>e+n.length+1,1),o=new Uint8Array(12+a+4),c=new DataView(o.buffer);c.setUint16(0,Math.floor(65535*Math.random()),!1),c.setUint16(2,256,!1),c.setUint16(4,1,!1);let l=12;for(const e of r)o[l++]=e.length,o.set(e,l),l+=e.length;return o[l++]=0,c.setUint16(l,t,!1),c.setUint16(l+2,1,!1),o}function parseDnsResponse(e,n,t){if(e.length<12)return{domain:n,type:t,status:"error"};const s=new DataView(e.buffer);if(0!==(15&s.getUint16(2,!1)))return{domain:n,type:t,status:"error"};const r=s.getUint16(4,!1),a=s.getUint16(6,!1);if(0===a)return{domain:n,type:t,status:"no_records",answers:[]};const o=[];let c=12;for(let n=0;n<r;n++)c=skipDnsName(e,c)+4;for(let n=0;n<a&&c<e.length;n++){const n=parseDnsAnswer(e,c);if(!n)break;o.push(n),c=n.nextOffset}return{domain:n,type:t,status:"success",count:a,answers:o}}function skipDnsName(e,n){let t=n;for(;t<e.length;){const n=e[t];if(0===n)return t+1;if(!(192&~n))return t+2;t+=n+1}return t}function parseDnsAnswer(e,n){const t=parseDnsName(e,n);if(!t)return null;let s=t.nextOffset;const r=new DataView(e.buffer),a=r.getUint16(s,!1),o=r.getUint32(s+4,!1),c=r.getUint16(s+8,!1);s+=10;let l=null;switch(a){case 1:4===c&&(l=`${e[s]}.${e[s+1]}.${e[s+2]}.${e[s+3]}`);break;case 28:16===c&&(l=parseIPv6(e,s));break;case 5:const n=parseDnsName(e,s);l=n?n.name:null;break;case 15:const t=r.getUint16(s,!1),a=parseDnsName(e,s+2);l={preference:t,exchange:a?a.name:null};break;case 16:const o=[];let u=0;for(;u<c;){const n=e[s+u];o.push(decoder.decode(e.slice(s+u+1,s+u+1+n))),u+=1+n}l=o.join("");break;case 2:const i=parseDnsName(e,s);l=i?i.name:null}return{name:t.name,type:{1:"A",28:"AAAA",5:"CNAME",15:"MX",16:"TXT",2:"NS"}[a]||a,ttl:o,data:l,nextOffset:s+c}}function parseIPv6(e,n){const t=[];for(let s=0;s<8;s++)t.push((e[n+2*s]<<8|e[n+2*s+1]).toString(16));let s=-1,r=0,a=-1,o=0;for(let e=0;e<8;e++)"0"===t[e]?(-1===a&&(a=e),o++,o>r&&(s=a,r=o)):(a=-1,o=0);return r>1&&(t.splice(s,r,""),0===s&&t.unshift(""),s+r===8&&t.push("")),t.join(":").replace(/:{3,}/,"::")}function parseDnsName(e,n){const t=[];let s=n,r=!1,a=-1,o=0;for(;!(o++>20||s>=e.length);){const n=e[s];if(0===n){r||(a=s+1);break}if(!(192&~n)){r||(a=s+2);s=(63&n)<<8|e[s+1],r=!0;continue}s++;let o="";for(let t=0;t<n;t++)o+=String.fromCharCode(e[s+t]);t.push(o),s+=n,r||(a=s)}return{name:t.join("."),nextOffset:a}}
