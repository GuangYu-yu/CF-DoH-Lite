const UPSTREAM_DOH_SERVERS=["https://cloudflare-dns.com/dns-query","https://dns.google/dns-query"],GLOBAL_AUTH_TOKEN="",CACHE_TTL_SECONDS=300,MIN_CACHE_TTL_SECONDS=60,TIMEOUT_MS=500;export default{async fetch(e){const n=new URL(e.url),t=n.pathname;if("OPTIONS"===e.method)return new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"*","Access-Control-Max-Age":"86400"}});switch(t){case"/dns-query":return await handleDnsQuery(e);case"/resolve":return await handleDomainResolve(e);default:return new Response(null,{status:200})}}};async function handleDnsQuery(e){let n;if("GET"===e.method){const t=new URL(e.url).searchParams.get("dns");if(!t)return new Response(null,{status:400});const s=atob(t.replace(/-/g,"+").replace(/_/g,"/"));n=new Uint8Array(s.length);for(let e=0;e<s.length;e++)n[e]=s.charCodeAt(e)}else{if("POST"!==e.method)return new Response(null,{status:405});if("application/dns-message"!==e.headers.get("content-type"))return new Response(null,{status:415});n=new Uint8Array(await e.arrayBuffer())}const{response:t,upstreamCacheControl:s}=await forwardDnsQueryWithCacheControl(n);if(!t)return new Response(null,{status:502});let r=300;if(s){const e=s.match(/max-age=(\d+)/);if(e){const n=parseInt(e[1],10);r=Math.max(60,Math.min(n,300))}}return new Response(t,{headers:{"Content-Type":"application/dns-message","Cache-Control":`public, max-age=${r}`,"Access-Control-Allow-Origin":"*"}})}async function handleDomainResolve(e){if("GET"!==e.method)return jsonResponse({},405);const n=new URL(e.url),t=n.searchParams.get("name");if(!t)return jsonResponse({},400);const s=n.searchParams.get("type"),r=n.searchParams.get("server"),o=r?[r]:UPSTREAM_DOH_SERVERS;if(s){const e=await queryDnsRecord(t,s,o);return e?jsonResponse(e):jsonResponse({},502)}{const[e,n]=await Promise.all([queryDnsRecord(t,"A",o),queryDnsRecord(t,"AAAA",o)]);return jsonResponse({domain:t,types:["A","AAAA"],status:"success",results:{A:e,AAAA:n}})}}async function forwardDnsQueryWithCacheControl(e,n=UPSTREAM_DOH_SERVERS){for(const t of n)try{const n=new AbortController,s=setTimeout(()=>n.abort(),500),r=await fetch(t,{method:"POST",headers:{Accept:"application/dns-message","Content-Type":"application/dns-message"},body:e,signal:n.signal});if(clearTimeout(s),r.ok){const e=r.headers.get("Cache-Control");return{response:new Uint8Array(await r.arrayBuffer()),upstreamCacheControl:e}}}catch(e){continue}return null}async function forwardDnsQuery(e,n=UPSTREAM_DOH_SERVERS){const t=await forwardDnsQueryWithCacheControl(e,n);return t?t.response:null}async function queryDnsRecord(e,n,t=UPSTREAM_DOH_SERVERS){const s=buildDnsQuery(e,n);if(!s)return null;const r=await forwardDnsQuery(s,t);return r?parseDnsResponse(r,e,n):null}function jsonResponse(e,n=200){return new Response(JSON.stringify(e,null,2),{status:n,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}function buildDnsQuery(e,n){const t={A:1,AAAA:28,CNAME:5,NS:2,TXT:16,MX:15}[n.toUpperCase()]||parseInt(n);if(!t)return null;const s=new TextEncoder,r=e.split(".").map(e=>s.encode(e)),o=r.reduce((e,n)=>e+n.length+1,1),a=new Uint8Array(12+o+4),l=new DataView(a.buffer);l.setUint16(0,Math.floor(65535*Math.random()),!1),l.setUint16(2,256,!1),l.setUint16(4,1,!1);let u=12;for(const e of r)a[u++]=e.length,a.set(e,u),u+=e.length;return a[u++]=0,l.setUint16(u,t,!1),l.setUint16(u+2,1,!1),a}function parseDnsResponse(e,n,t){if(e.length<12)return{domain:n,type:t,status:"error"};const s=new DataView(e.buffer);if(0!==(15&s.getUint16(2,!1)))return{domain:n,type:t,status:"error"};const r=s.getUint16(4,!1),o=s.getUint16(6,!1);if(0===o)return{domain:n,type:t,status:"no_records",answers:[]};const a=[];let l=12;for(let n=0;n<r;n++)l=skipDnsName(e,l)+4;for(let n=0;n<o&&l<e.length;n++){const n=parseDnsAnswer(e,l);if(!n)break;a.push(n),l=n.nextOffset}return{domain:n,type:t,status:"success",count:o,answers:a}}function skipDnsName(e,n){let t=n;for(;t<e.length;){const n=e[t];if(0===n)return t+1;if(!(192&~n))return t+2;t+=n+1}return t}function parseDnsAnswer(e,n){const t=parseDnsName(e,n);if(!t)return null;let s=t.nextOffset;const r=new DataView(e.buffer),o=r.getUint16(s,!1),a=r.getUint32(s+4,!1),l=r.getUint16(s+8,!1);s+=10;let u=null;if(1===o&&4===l)u=`${e[s]}.${e[s+1]}.${e[s+2]}.${e[s+3]}`;else if(28===o&&16===l)u=parseIPv6(e,s);else if(5===o){const n=parseDnsName(e,s);u=n?n.name:null}return{name:t.name,type:{1:"A",28:"AAAA",5:"CNAME"}[o]||o,ttl:a,data:u,nextOffset:s+l}}function parseIPv6(e,n){const t=[];for(let s=0;s<8;s++)t.push((e[n+2*s]<<8|e[n+2*s+1]).toString(16));let s=-1,r=0,o=-1,a=0;for(let e=0;e<8;e++)"0"===t[e]?(-1===o&&(o=e),a++,a>r&&(s=o,r=a)):(o=-1,a=0);return r>1&&(t.splice(s,r,""),0===s&&t.unshift(""),s+r===8&&t.push("")),t.join(":").replace(/:{3,}/,"::")}function parseDnsName(e,n){const t=[];let s=n,r=!1,o=-1,a=0;for(;!(a++>20||s>=e.length);){const n=e[s];if(0===n){r||(o=s+1);break}if(!(192&~n)){r||(o=s+2);s=(63&n)<<8|e[s+1],r=!0;continue}s++;let a="";for(let t=0;t<n;t++)a+=String.fromCharCode(e[s+t]);t.push(a),s+=n,r||(o=s)}return{name:t.join("."),nextOffset:o}}
