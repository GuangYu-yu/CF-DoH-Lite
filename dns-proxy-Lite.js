const UPSTREAM_DOH_SERVERS=["https://cloudflare-dns.com/dns-query","https://dns.google/dns-query"],GLOBAL_AUTH_TOKEN="",CACHE_MAX_AGE_SECONDS=300;export default{async fetch(e,t,s){const n=new URL(e.url),r=n.pathname;if("OPTIONS"===e.method)return new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"*","Access-Control-Max-Age":"86400"}});switch(r){case"/dns-query":return await handleDnsQuery(e,s);case"/resolve":return await handleDomainResolve(e,s);default:return new Response("DNS Worker is running.",{headers:{"Content-Type":"text/plain; charset=utf-8"}})}}};async function handleDnsQuery(e,t){const s=new Request(e.url,e),n=await caches.default.match(s);if(n){const e=new Headers(n.headers);return e.set("Cache-Control","public, max-age=300"),new Response(n.body,{status:n.status,statusText:n.statusText,headers:e})}for(const n of UPSTREAM_DOH_SERVERS)try{const r=new AbortController,a=setTimeout(()=>r.abort(),500),o=new URL(n);if("GET"===e.method){const t=new URL(e.url);o.search=t.search}const c=await fetch(o,{method:e.method,headers:{Accept:"application/dns-message","Content-Type":"application/dns-message"},body:e.body,signal:r.signal});if(clearTimeout(a),c.ok){const e=c.clone(),n=new Headers(c.headers);n.set("Cache-Control","public, max-age=300");const r=new Response(e.body,{status:c.status,statusText:c.statusText,headers:n});return t.waitUntil((async()=>{const e=await caches.open("dns-cache");await e.put(s,r)})()),new Response(c.body,{status:c.status,statusText:c.statusText,headers:c.headers})}console.warn(`Upstream ${n} returned status ${c.status}`)}catch(e){console.error(`DNS query failed for ${n}:`,e.message);continue}return new Response("DNS query failed",{status:502})}async function handleDomainResolve(e,t){if("GET"!==e.method)return jsonResponse({error:"Method Not Allowed"},405);const s=new URL(e.url),n=s.searchParams.get("name");if(!n)return jsonResponse({error:"Missing name parameter"},400);const r=s.searchParams.get("type"),a=s.searchParams.get("server")||UPSTREAM_DOH_SERVERS[0],o=new Request(e.url,e),c=await caches.default.match(o);if(c){const e=new Headers(c.headers);return e.set("Cache-Control","public, max-age=300"),new Response(c.body,{status:c.status,statusText:c.statusText,headers:e})}try{let e;if(r){const t=new URL(a);t.searchParams.set("name",n),t.searchParams.set("type",r);const s=new AbortController,o=setTimeout(()=>s.abort(),500),c=await fetch(t,{method:"GET",headers:{Accept:"application/dns-message"},signal:s.signal});if(clearTimeout(o),!c.ok)return jsonResponse({error:"DNS query failed",domain:n,type:r},502);e=parseDnsResponse(new Uint8Array(await c.arrayBuffer()),n,r)}else{const t=new AbortController,s=setTimeout(()=>t.abort(),500),r=new URL(a);r.searchParams.set("name",n),r.searchParams.set("type","A");const o=new URL(a);o.searchParams.set("name",n),o.searchParams.set("type","AAAA");const[c,l]=await Promise.all([fetch(r,{method:"GET",headers:{Accept:"application/dns-message"},signal:t.signal}),fetch(o,{method:"GET",headers:{Accept:"application/dns-message"},signal:t.signal})]);clearTimeout(s);let u=null,i=null;if(c.ok){u=parseDnsResponse(new Uint8Array(await c.arrayBuffer()),n,"A")}if(l.ok){i=parseDnsResponse(new Uint8Array(await l.arrayBuffer()),n,"AAAA")}e={domain:n,types:["A","AAAA"],status:"success",results:{A:u,AAAA:i}}}const s=jsonResponse(e),c=s.clone(),l=new Headers(s.headers);l.set("Cache-Control","public, max-age=300");const u=new Response(c.body,{status:s.status,statusText:s.statusText,headers:l});return t.waitUntil((async()=>{const e=await caches.open("dns-cache");await e.put(o,u)})()),s}catch(e){return jsonResponse({error:"Internal Server Error",message:e.message},500)}}async function queryDnsRecord(e,t,s=UPSTREAM_DOH_SERVERS){const n=new URL(s[0]);n.searchParams.set("name",e),n.searchParams.set("type",t);try{const r=new AbortController,a=setTimeout(()=>r.abort(),500),o=await fetch(n,{method:"GET",headers:{Accept:"application/dns-message"},signal:r.signal});if(clearTimeout(a),o.ok){return parseDnsResponse(new Uint8Array(await o.arrayBuffer()),e,t)}return console.warn(`Upstream ${s[0]} returned status ${o.status}`),null}catch(e){return console.error(`DNS query failed for ${s[0]}:`,e.message),null}}function jsonResponse(e,t=200){return new Response(JSON.stringify(e,null,2),{status:t,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}function buildDnsQuery(e,t){let s="string"==typeof t?{A:1,AAAA:28,CNAME:5,NS:2,TXT:16,MX:15}[t.toUpperCase()]:t;if(s||isNaN(t)||(s=parseInt(t)),!s)return null;const n=new Uint8Array(12),r=new DataView(n.buffer);r.setUint16(0,Math.floor(65535*Math.random()),!1),r.setUint16(2,256,!1),r.setUint16(4,1,!1);const a=e.split(".");let o=0;for(const e of a)o+=e.length+1;o+=1;const c=new Uint8Array(o+4);let l=0;for(const e of a){if(e.length>63)return null;c[l]=e.length,l++;for(let t=0;t<e.length;t++)c[l]=e.charCodeAt(t),l++}c[l]=0,l++;const u=new DataView(c.buffer);u.setUint16(l,s,!1),u.setUint16(l+2,1,!1);const i=new Uint8Array(12+c.length);return i.set(n),i.set(c,12),i}function parseDnsResponse(e,t,s){if(e.length<12)return{domain:t,type:s,status:"error",error:"Invalid DNS response"};const n=new DataView(e.buffer),r=15&n.getUint16(2,!1);if(0!==r)return{domain:t,type:s,status:"error",error:`DNS error code: ${r}`};const a=n.getUint16(6,!1);if(0===a)return{domain:t,type:s,status:"no_records",answers:[]};const o=[];let c=skipDnsName(e,12)+4;for(let t=0;t<a&&c<e.length;t++){const t=parseDnsAnswer(e,c);if(!t)break;o.push(t),c=t.nextOffset}return{domain:t,type:s,status:"success",count:a,answers:o}}function skipDnsName(e,t){let s=t;for(;s<e.length;){const t=e[s];if(0===t){s++;break}if(!(192&~t)){s+=2;break}s+=t+1}return s}function parseDnsAnswer(e,t){if(t>=e.length)return null;const s=parseDnsName(e,t);if(!s)return null;if((t=s.nextOffset)+10>e.length)return null;const n=new DataView(e.buffer),r=n.getUint16(t,!1),a=n.getUint32(t+4,!1),o=n.getUint16(t+8,!1);if((t+=10)+o>e.length)return null;const c=parseRecordData(e,t,r,o);return{name:s.name,type:{1:"A",28:"AAAA",5:"CNAME",2:"NS",16:"TXT",15:"MX"}[r]||r,ttl:a,data:c,nextOffset:t+o}}function parseDnsName(e,t){const s=[];let n=t;for(;n<e.length;){const t=e[n];if(0===t){n++;break}if(!(192&~t)){if(n+1>=e.length)return null;const r=(63&t)<<8|e[n+1];if(r>=n)return null;const a=parseDnsName(e,r);a&&s.push(...a.name.split(".")),n+=2;break}{if(n+1+t>e.length)return null;let r="";for(let s=1;s<=t;s++)r+=String.fromCharCode(e[n+s]);s.push(r),n+=t+1}}return{name:s.join("."),nextOffset:n}}function parseRecordData(e,t,s,n){switch(s){case 1:return 4!==n?null:`${e[t]}.${e[t+1]}.${e[t+2]}.${e[t+3]}`;case 28:if(16!==n)return null;const s=[];for(let n=0;n<16;n+=2){const n=(e[t]<<8|e[t+1]).toString(16);s.push(n),t+=2}return compressIPv6(s.join(":"));case 5:case 2:const r=parseDnsName(e,t);return r?r.name:null;case 16:let a=t,o="";for(;a<t+n;){const s=e[a];if(0===s||a+1+s>t+n)break;o+=(o?" ":"")+String.fromCharCode(...e.slice(a+1,a+1+s)),a+=1+s}return o;case 15:if(n<2)return null;const c=e[t]<<8|e[t+1],l=parseDnsName(e,t+2);return l?`${c} ${l.name}`:null;default:return null}}function compressIPv6(e){const t=e.split(":");let s=-1,n=0,r=-1,a=0;for(let e=0;e<t.length;e++)"0"===t[e]?-1===r?(r=e,a=1):a++:(a>n&&(s=r,n=a),r=-1,a=0);if(a>n&&(s=r,n=a),n>1){return[...t.slice(0,s),"",...t.slice(s+n)].join(":")}return e}
