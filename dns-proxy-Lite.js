const UPSTREAM_DOH_SERVERS=["https://cloudflare-dns.com/dns-query","https://dns.google/dns-query"],GLOBAL_AUTH_TOKEN="";export default{async fetch(e,t,n){const s=new URL(e.url),r=s.pathname;if("OPTIONS"===e.method)return new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"*","Access-Control-Max-Age":"86400"}});switch(r){case"/dns-query":return await handleDnsQuery(e);case"/resolve":return await handleDomainResolve(e);default:return new Response("DNS Worker is running.",{headers:{"Content-Type":"text/plain; charset=utf-8"}})}}};async function handleDnsQuery(e){for(const t of UPSTREAM_DOH_SERVERS)try{const n=new AbortController,s=setTimeout(()=>n.abort(),500),r=new URL(t);if("GET"===e.method){const t=new URL(e.url);r.search=t.search}const a=await fetch(r,{method:e.method,headers:{Accept:"application/dns-message","Content-Type":"application/dns-message"},body:e.body,signal:n.signal});if(clearTimeout(s),a.ok)return new Response(a.body,{status:a.status,statusText:a.statusText,headers:a.headers});console.warn(`Upstream ${t} returned status ${a.status}`)}catch(e){console.error(`DNS query failed for ${t}:`,e.message);continue}return new Response("DNS query failed",{status:502})}async function handleDomainResolve(e){if("GET"!==e.method)return jsonResponse({error:"Method Not Allowed"},405);const t=new URL(e.url),n=t.searchParams.get("name");if(!n)return jsonResponse({error:"Missing name parameter"},400);const s=t.searchParams.get("type"),r=t.searchParams.get("server")||UPSTREAM_DOH_SERVERS[0];try{if(s){const e=new URL(r);e.searchParams.set("name",n),e.searchParams.set("type",s);const t=new AbortController,a=setTimeout(()=>t.abort(),500),o=await fetch(e,{method:"GET",headers:{Accept:"application/dns-message"},signal:t.signal});if(clearTimeout(a),o.ok){const e=new Uint8Array(await o.arrayBuffer());return jsonResponse(parseDnsResponse(e,n,s))}return jsonResponse({error:"DNS query failed",domain:n,type:s},502)}{const e=new AbortController,t=setTimeout(()=>e.abort(),500),s=new URL(r);s.searchParams.set("name",n),s.searchParams.set("type","A");const a=new URL(r);a.searchParams.set("name",n),a.searchParams.set("type","AAAA");const[o,l]=await Promise.all([fetch(s,{method:"GET",headers:{Accept:"application/dns-message"},signal:e.signal}),fetch(a,{method:"GET",headers:{Accept:"application/dns-message"},signal:e.signal})]);clearTimeout(t);let i=null,c=null;if(o.ok){i=parseDnsResponse(new Uint8Array(await o.arrayBuffer()),n,"A")}if(l.ok){c=parseDnsResponse(new Uint8Array(await l.arrayBuffer()),n,"AAAA")}return jsonResponse({domain:n,types:["A","AAAA"],status:"success",results:{A:i,AAAA:c}})}}catch(e){return jsonResponse({error:"Internal Server Error",message:e.message},500)}}async function queryDnsRecord(e,t,n=UPSTREAM_DOH_SERVERS){const s=new URL(n[0]);s.searchParams.set("name",e),s.searchParams.set("type",t);try{const r=new AbortController,a=setTimeout(()=>r.abort(),500),o=await fetch(s,{method:"GET",headers:{Accept:"application/dns-message"},signal:r.signal});if(clearTimeout(a),o.ok){return parseDnsResponse(new Uint8Array(await o.arrayBuffer()),e,t)}return console.warn(`Upstream ${n[0]} returned status ${o.status}`),null}catch(e){return console.error(`DNS query failed for ${n[0]}:`,e.message),null}}function jsonResponse(e,t=200){return new Response(JSON.stringify(e,null,2),{status:t,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}function buildDnsQuery(e,t){let n="string"==typeof t?{A:1,AAAA:28,CNAME:5,NS:2,TXT:16,MX:15}[t.toUpperCase()]:t;if(n||isNaN(t)||(n=parseInt(t)),!n)return null;const s=new Uint8Array(12),r=new DataView(s.buffer);r.setUint16(0,Math.floor(65535*Math.random()),!1),r.setUint16(2,256,!1),r.setUint16(4,1,!1);const a=e.split(".");let o=0;for(const e of a)o+=e.length+1;o+=1;const l=new Uint8Array(o+4);let i=0;for(const e of a){if(e.length>63)return null;l[i]=e.length,i++;for(let t=0;t<e.length;t++)l[i]=e.charCodeAt(t),i++}l[i]=0,i++;const c=new DataView(l.buffer);c.setUint16(i,n,!1),c.setUint16(i+2,1,!1);const u=new Uint8Array(12+l.length);return u.set(s),u.set(l,12),u}function parseDnsResponse(e,t,n){if(e.length<12)return{domain:t,type:n,status:"error",error:"Invalid DNS response"};const s=new DataView(e.buffer),r=15&s.getUint16(2,!1);if(0!==r)return{domain:t,type:n,status:"error",error:`DNS error code: ${r}`};const a=s.getUint16(6,!1);if(0===a)return{domain:t,type:n,status:"no_records",answers:[]};const o=[];let l=skipDnsName(e,12)+4;for(let t=0;t<a&&l<e.length;t++){const t=parseDnsAnswer(e,l);if(!t)break;o.push(t),l=t.nextOffset}return{domain:t,type:n,status:"success",count:a,answers:o}}function skipDnsName(e,t){let n=t;for(;n<e.length;){const t=e[n];if(0===t){n++;break}if(!(192&~t)){n+=2;break}n+=t+1}return n}function parseDnsAnswer(e,t){if(t>=e.length)return null;const n=parseDnsName(e,t);if(!n)return null;if((t=n.nextOffset)+10>e.length)return null;const s=new DataView(e.buffer),r=s.getUint16(t,!1),a=s.getUint32(t+4,!1),o=s.getUint16(t+8,!1);if((t+=10)+o>e.length)return null;const l=parseRecordData(e,t,r,o);return{name:n.name,type:{1:"A",28:"AAAA",5:"CNAME",2:"NS",16:"TXT",15:"MX"}[r]||r,ttl:a,data:l,nextOffset:t+o}}function parseDnsName(e,t){const n=[];let s=t;for(;s<e.length;){const t=e[s];if(0===t){s++;break}if(!(192&~t)){if(s+1>=e.length)return null;const r=(63&t)<<8|e[s+1];if(r>=s)return null;const a=parseDnsName(e,r);a&&n.push(...a.name.split(".")),s+=2;break}{if(s+1+t>e.length)return null;let r="";for(let n=1;n<=t;n++)r+=String.fromCharCode(e[s+n]);n.push(r),s+=t+1}}return{name:n.join("."),nextOffset:s}}function parseRecordData(e,t,n,s){switch(n){case 1:return 4!==s?null:`${e[t]}.${e[t+1]}.${e[t+2]}.${e[t+3]}`;case 28:if(16!==s)return null;const n=[];for(let s=0;s<16;s+=2){const s=(e[t]<<8|e[t+1]).toString(16);n.push(s),t+=2}return compressIPv6(n.join(":"));case 5:case 2:const r=parseDnsName(e,t);return r?r.name:null;case 16:let a=t,o="";for(;a<t+s;){const n=e[a];if(0===n||a+1+n>t+s)break;o+=(o?" ":"")+String.fromCharCode(...e.slice(a+1,a+1+n)),a+=1+n}return o;case 15:if(s<2)return null;const l=e[t]<<8|e[t+1],i=parseDnsName(e,t+2);return i?`${l} ${i.name}`:null;default:return null}}function compressIPv6(e){const t=e.split(":");let n=-1,s=0,r=-1,a=0;for(let e=0;e<t.length;e++)"0"===t[e]?-1===r?(r=e,a=1):a++:(a>s&&(n=r,s=a),r=-1,a=0);if(a>s&&(n=r,s=a),s>1){return[...t.slice(0,n),"",...t.slice(n+s)].join(":")}return e}
