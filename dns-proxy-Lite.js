const UPSTREAM_DOH_SERVERS=["https://cloudflare-dns.com/dns-query","https://dns.google/dns-query"],GLOBAL_AUTH_TOKEN="",TIMEOUT_MS=500,CACHE_TTL_SECONDS=300;export default{async fetch(e,s,t){const n=new URL(e.url),o=n.pathname;return"OPTIONS"===e.method?new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"*","Access-Control-Max-Age":"86400"}}):"/dns-query"===o?await handleDnsQuery(e,t):new Response("DNS Worker is running.",{headers:{"Content-Type":"text/plain; charset=utf-8"}})}};async function handleDnsQuery(e,s){const t=e.method;if("GET"!==t&&"POST"!==t)return new Response("Method Not Allowed",{status:405});const n=caches.default;if("GET"===t){const s=await n.match(e);if(s){const e=new Headers(s.headers);return e.set("Access-Control-Allow-Origin","*"),new Response(s.body,{status:s.status,statusText:s.statusText,headers:e})}}let o=null;"POST"===t&&(o=await e.arrayBuffer());for(const a of UPSTREAM_DOH_SERVERS){const r=new AbortController,c=setTimeout(()=>r.abort(),500),l=new URL(a);if("GET"===t){const s=new URL(e.url);l.search=s.search}const u={method:t,headers:{Accept:"application/dns-message"},signal:r.signal};"POST"===t&&(u.headers["Content-Type"]="application/dns-message",u.body=o);const d=await fetch(l,u);if(clearTimeout(c),d.ok){const o=new Headers(d.headers);if(o.set("Access-Control-Allow-Origin","*"),o.set("Cache-Control","public, max-age=300"),"GET"===t){const t=d.clone(),o=new Headers(t.headers);o.set("Cache-Control","public, max-age=300"),o.set("Access-Control-Allow-Origin","*");const a=new Response(t.body,{status:t.status,statusText:t.statusText,headers:o});s.waitUntil(n.put(e.clone(),a))}return new Response(d.body,{status:d.status,statusText:d.statusText,headers:o})}}return new Response("failed",{status:502})}
