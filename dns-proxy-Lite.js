const UPSTREAM_DOH_SERVERS=["https://cloudflare-dns.com/dns-query","https://dns.google/dns-query"],GLOBAL_AUTH_TOKEN="",TIMEOUT_MS=500,CACHE_TTL_SECONDS=300,MIN_CACHE_TTL_SECONDS=60;export default{async fetch(e,s,t){const n=new URL(e.url),a=n.pathname;return"OPTIONS"===e.method?new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"*","Access-Control-Max-Age":"86400"}}):"/dns-query"===a?await handleDnsQuery(e,t):new Response(null,{status:200})}};async function handleDnsQuery(e,s){const t=e.method;if("GET"!==t&&"POST"!==t)return new Response(null,{status:405});const n=caches.default;if("GET"===t){const s=await n.match(e);if(s){const e=new Headers(s.headers);return e.set("Access-Control-Allow-Origin","*"),new Response(s.body,{status:s.status,statusText:s.statusText,headers:e})}}let a=null;"POST"===t&&(a=await e.arrayBuffer());for(const o of UPSTREAM_DOH_SERVERS){const r=new AbortController,c=setTimeout(()=>r.abort(),500),l=new URL(o);if("GET"===t){const s=new URL(e.url);l.search=s.search}const u={method:t,headers:{Accept:"application/dns-message"},signal:r.signal};"POST"===t&&(u.headers["Content-Type"]="application/dns-message",u.body=a);const d=await fetch(l,u);if(clearTimeout(c),d.ok){const a=new Headers(d.headers);a.set("Access-Control-Allow-Origin","*");const o=d.headers.get("Cache-Control");let r=300;if(o){const e=o.match(/max-age=(\d+)/);if(e){const s=parseInt(e[1],10);r=Math.max(60,Math.min(s,300))}}if(a.set("Cache-Control",`public, max-age=${r}`),"GET"===t){const t=d.clone(),a=new Headers(t.headers);a.set("Cache-Control",`public, max-age=${r}`),a.set("Access-Control-Allow-Origin","*");const o=new Response(t.body,{status:t.status,statusText:t.statusText,headers:a});s.waitUntil(n.put(e.clone(),o))}return new Response(d.body,{status:d.status,statusText:d.statusText,headers:a})}}return new Response(null,{status:502})}
